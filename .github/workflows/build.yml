name: Build Proxmox-ISO-t2

on:
  push:
    branches: [ senpai, main ]
    tags:     [ 'v*' ]
  pull_request:
    branches: [ senpai, main ]
  workflow_dispatch:
    inputs:
      pve_version:
        description: 'Proxmox VE version to target (e.g. 8.4)'
        required: false
        default: ''
      t2_kernel_version:
        description: 'T2 kernel version tag (e.g. 6.17.13-1-t2-1)'
        required: false
        default: ''
      create_release:
        description: 'Create a GitHub Release from this build'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: write   # required to create GitHub Releases and upload assets

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update -q
          sudo apt-get install -y \
            xorriso \
            squashfs-tools \
            mtools \
            curl \
            wget \
            gpg \
            dosfstools \
            grub-pc-bin \
            grub-efi-amd64-bin \
            isolinux

      - name: Override versions from workflow_dispatch inputs
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [[ -n "${{ github.event.inputs.pve_version }}" ]]; then
            sed -i "s/^PVE_VERSION=.*/PVE_VERSION=\"${{ github.event.inputs.pve_version }}\"/" build.conf
          fi
          if [[ -n "${{ github.event.inputs.t2_kernel_version }}" ]]; then
            sed -i "s/^T2_KERNEL_VERSION=.*/T2_KERNEL_VERSION=\"${{ github.event.inputs.t2_kernel_version }}\"/" build.conf
          fi

      - name: Compute release tag
        id: release_tag
        run: |
          if [[ "${{ github.event_name }}" == 'push' && "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "tag=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
            echo "do_release=true" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.event_name }}" == 'workflow_dispatch' && "${{ github.event.inputs.create_release }}" == 'true' ]]; then
            source build.conf
            TAG="v${PVE_VERSION}-t2-$(date -u +%Y%m%d%H%M)"
            echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
            echo "do_release=true" >> "$GITHUB_OUTPUT"
            # Push the tag so softprops/action-gh-release can find it
            git config user.name  "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag "${TAG}"
            git push origin "${TAG}"
          else
            echo "do_release=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Cache Proxmox VE ISO
        uses: actions/cache@v4
        with:
          path: work/*.iso
          key: pve-iso-${{ hashFiles('build.conf') }}
          restore-keys: pve-iso-

      - name: Cache T2 kernel packages
        uses: actions/cache@v4
        with:
          path: packages/*.deb
          key: t2-kernel-${{ hashFiles('build.conf') }}
          restore-keys: t2-kernel-

      - name: Run prepare.sh
        run: bash prepare.sh

      - name: Run build.sh
        run: sudo bash build.sh

      - name: Verify ISO integrity
        run: |
          sha256sum --check out/*.sha256
          echo "--- ISO details ---"
          ls -lh out/*.iso

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: proxmox-ve-t2-iso
          path: |
            out/*.iso
            out/*.sha256
          retention-days: 14

      - name: Create GitHub Release
        if: steps.release_tag.outputs.do_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          prerelease: ${{ github.event_name == 'workflow_dispatch' }}
          files: |
            out/*.iso
            out/*.sha256
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
