# Proxmox VE - T2 Mac Edition - GRUB Configuration
# Based on official Proxmox VE grub.cfg with T2 kernel parameters added.
# Replaces both /boot/grub/grub.cfg and /EFI/BOOT/grub.cfg in the ISO.
#
# T2-required kernel parameters (applied to all entries via t2_params):
#   intel_iommu=on   — enable VT-d IOMMU; required for T2 PCIe device enumeration
#   iommu=pt         — passthrough mode; reduces IOMMU overhead without breaking devices
#   pcie_ports=compat — required for Apple T2 PCIe port compatibility

set default=0
set timeout=10

# T2 Mac kernel parameters — applied to every boot entry
set t2_params="intel_iommu=on iommu=pt pcie_ports=compat"

loadfont /boot/grub/unicode.pf2

if loadfont /boot/grub/pvetheme/ascii.pf2; then
  set gfxmode=1024x768
  insmod all_video
  insmod gfxterm
  terminal_output gfxterm
fi

if [ -e /boot/grub/pvetheme/background.png ]; then
  insmod png
  background_image /boot/grub/pvetheme/background.png
fi

# ── Graphical Installation (default) ─────────────────────────────────────────
menuentry "Proxmox VE T2 - Graphical Install" {
    set gfxpayload=keep
    linux  /boot/linux26 ro ramdisk_size=16777216 rw quiet splash=silent \
           ${t2_params}
    initrd /boot/initrd.img
}

# ── Terminal UI Installation ──────────────────────────────────────────────────
menuentry "Proxmox VE T2 - Terminal Install" {
    linux  /boot/linux26 ro ramdisk_size=16777216 rw quiet splash=silent \
           proxtui vga=788 ${t2_params}
    initrd /boot/initrd.img
}

# ── Serial Console Installation ───────────────────────────────────────────────
menuentry "Proxmox VE T2 - Serial Console" {
    linux  /boot/linux26 ro ramdisk_size=16777216 rw quiet \
           console=ttyS0,115200 ${t2_params}
    initrd /boot/initrd.img
}

# ── Automated Installation (only shown if answer file is present) ─────────────
if [ -e /auto-installer-mode.toml ]; then
    menuentry "Proxmox VE T2 - Automated Install" {
        set gfxpayload=keep
        linux  /boot/linux26 ro ramdisk_size=16777216 rw quiet splash=silent \
               proxmox-start-auto-installer ${t2_params}
        initrd /boot/initrd.img
    }
fi

# ── Advanced Options ──────────────────────────────────────────────────────────
submenu "Advanced Options -->" {

    menuentry "Proxmox VE T2 - Debug Mode (Graphical)" {
        set gfxpayload=keep
        linux  /boot/linux26 ro ramdisk_size=16777216 rw splash=verbose \
               proxdebug ${t2_params}
        initrd /boot/initrd.img
    }

    menuentry "Proxmox VE T2 - Debug Mode (Terminal)" {
        linux  /boot/linux26 ro ramdisk_size=16777216 rw \
               proxtui vga=788 proxdebug ${t2_params}
        initrd /boot/initrd.img
    }

    menuentry "Proxmox VE T2 - Rescue Boot" {
        linux  /boot/linux26 ro ramdisk_size=16777216 rw \
               proxtui vga=788 proxrescue ${t2_params}
        initrd /boot/initrd.img
    }

    menuentry "Proxmox VE T2 - Nomodeset Fallback" {
        linux  /boot/linux26 ro ramdisk_size=16777216 rw quiet \
               nomodeset ${t2_params}
        initrd /boot/initrd.img
    }

}
